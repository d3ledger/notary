- name: Clean files dir
  local_action:
    module: file
    path: "{{ role_path }}/files/"
    state: absent
  run_once: yes
  become: no

- name: Create notary accounts
  local_action:
    module: shell
    _raw_params: >
      ./create_account.sh notary_{{ inventory_hostname}} {{ eth_pass }}
    chdir: "{{ role_path }}"
  become: no

- name: Create other ethereum accounts
  local_action:
    module: shell
    _raw_params: >
      ./create_account.sh {{ item }} {{ eth_pass }}
    chdir: "{{ role_path }}"
  with_items:
    - withdrawal
    - registration
    - relay_registration
    - vacuum
  become: no
  run_once: yes

- name: Create notary addr list file
  local_action:
    module: shell
    _raw_params: >
      printf 0x'{{ lookup('file','files/notary_{{ inventory_hostname }}.key')
        | from_json
        |  json_query('address') }} ' \
        >> list.txt
    chdir: "{{ role_path }}/files"
  become: no

- name: Set notary addrs
  local_action:
    module: shell
    _raw_params: >
      cat list.txt
    chdir: "{{ role_path }}/files"
  become: no
  register: addrs

- debug: var=addrs.stdout

- name: Deploy relay registry and master contract
  local_action:
    module: shell
    _raw_params: >
      ./gradlew runPreDeployEthereum --args='{{ addrs.stdout }}'
    chdir: "{{ playbook_dir }}/../../"
  environment:
    PROFILE: testnet
  register: file

  become: no
  run_once: yes


- name: Write master contract address
  local_action:
    module: copy
    content: "{{ (file.stdout.split('\n') | select('search', 'master_eth_address:::') | list | first).split(' ') | last }}"
    dest: "{{ role_path }}/files/master_eth_address"
  become: no

- name: Write relay registry address
  local_action:
    module: copy
    content: "{{ (file.stdout.split('\n') | select('search', 'relay_registry_eth_address:::') | list | first).split(' ') | last }}"
    dest: "{{ role_path }}/files/relay_registry_eth_address"
  become: no

