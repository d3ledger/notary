- name: Clean files dir
  file:
    path: "{{ role_path }}/files/"
    state: absent
  run_once: yes
  become: no
  delegate_to: localhost


- name: Create notary accounts
  shell:
    _raw_params: >
      ./create_account.sh notary_{{ inventory_hostname}} {{ eth_pass }}
    chdir: "{{ role_path }}"
  become: no
  delegate_to: localhost


- name: Create other ethereum accounts
  shell:
    _raw_params: >
      ./create_account.sh {{ item }} {{ eth_pass }}
    chdir: "{{ role_path }}"
  with_items:
    - withdrawal
    - registration
    - relay_registration
    - vacuum
  become: no
  run_once: yes
  delegate_to: localhost


- name: Create notary addr list file
  shell:
    _raw_params: >
      printf 0x'{{ lookup('file','files/notary_{{ inventory_hostname }}.key')
        | from_json
        |  json_query('address') }} ' \
        >> list.txt
    chdir: "{{ role_path }}/files"
  become: no
  delegate_to: localhost


- name: Set notary addrs
  shell:
    _raw_params: >
      cat list.txt
    chdir: "{{ role_path }}/files"
  become: no
  register: addrs
  delegate_to: localhost
  run_once: yes


- name: Deploy relay registry and master contract
  shell:
    _raw_params: >
      ./gradlew runPreDeployEthereum --args='{{ addrs.stdout }}'
    chdir: "{{ playbook_dir }}/../../"
  environment:
    PROFILE: testnet
  register: file
  delegate_to: localhost
  become: no
  run_once: yes


- name: Write master contract address
  copy:
    src: "{{ playbook_dir }}/../../master_eth_address"
    dest: "{{ role_path }}/files/master_eth_address"
  become: no
  run_once: yes
  delegate_to: localhost

- name: Write relay registry address
  copy:
    src: "{{ playbook_dir }}/../../relay_registry_eth_address"
    dest: "{{ role_path }}/files/relay_registry_eth_address"
  become: no
  run_once: yes
  delegate_to: localhost

