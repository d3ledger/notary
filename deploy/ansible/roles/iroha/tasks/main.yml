---

  - name: Compile kotlin script
    local_action:
      module: shell
      _raw_params: >
       kotlinc -cp {{ projectRoot }}/iroha_bindings/iroha-bindings-example.jar generateKeypair.kt
       -include-runtime -d GenerateKeypair.jar
      chdir: "{{ projectRoot }}/deploy/ansible/roles/iroha"
    run_once: yes
    become: no

  - name: Generate iroha keypairs
    local_action:
      module: shell
      _raw_params: >
        kotlin
        -classpath {{ projectRoot }}/iroha_bindings/iroha-bindings-example.jar
        -classpath GenerateKeypair.jar
        -Djava.library.path={{ projectRoot }}/iroha_bindings/mac
        GenerateKeypairKt {{ item }}
      chdir: "{{ projectRoot }}/deploy/ansible/roles/iroha"
    register: "keys"
    with_inventory_hostnames:
      - all
    run_once: yes
    become: no

  - name: Remove nodes.csv file
    local_action:
      module: file
      path: "{{ projectRoot }}/deploy/ansible/roles/iroha/nodes.csv"
      state: absent
    become: no


  - name: Write nodes to file
    local_action:
      module: lineinfile
      path: "{{ projectRoot }}/deploy/ansible/roles/iroha/nodes.csv"
      line: "{{ hostvars[item.0]['ansible_host'] }};10001;{{ item.1.stdout }}"
      create: yes
    with_together:
      - "{{ play_hosts }}"
      - "{{ keys.results }}"
    run_once: yes
    become: no

  - name: Copy genesis block
    local_action:
      module: copy
      src: "{{ projectRoot }}/deploy/iroha/genesis.block"
      dest: "{{ projectRoot }}/deploy/ansible/roles/iroha"
    run_once: yes
    become: no

  - name: Add peers to genesis block
    local_action:
      module: shell
      _raw_params: "python add_peers.py nodes.csv"
      chdir: "{{ projectRoot }}/deploy/ansible/roles/iroha"
    register: stdout
    run_once: yes
    become: no
